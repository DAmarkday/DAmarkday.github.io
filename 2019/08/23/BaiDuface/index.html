<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <title>小程序人脸动态识别摇头点头采坑建议 | 桥桥的代码小屋</title>
  <meta name="keywords" content=" 微信小程序 , javascript , 人脸识别 ">
  <meta name="description" content="小程序人脸动态识别摇头点头采坑建议 | 桥桥的代码小屋">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="个人简介  &amp;emsp;&amp;emsp;大学生一枚，专业软件工程，对于热衷学习计算机知识，渴望能接触一流的软件开发流程和一线的技术。    联系方式 QQ: 1060172264 e-mail: DAmarkday@163.com  致谢&amp;emsp;&amp;emsp;非常感谢 叶落阁 大佬的主题和说明，让我能很大程序理解博客的构造和搭建。">
<meta property="og:type" content="website">
<meta property="og:title" content="关于博客">
<meta property="og:url" content="http://DAmarkday.com/about/index.html">
<meta property="og:site_name" content="桥桥的代码小屋">
<meta property="og:description" content="个人简介  &amp;emsp;&amp;emsp;大学生一枚，专业软件工程，对于热衷学习计算机知识，渴望能接触一流的软件开发流程和一线的技术。    联系方式 QQ: 1060172264 e-mail: DAmarkday@163.com  致谢&amp;emsp;&amp;emsp;非常感谢 叶落阁 大佬的主题和说明，让我能很大程序理解博客的构造和搭建。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-07-31T04:02:24.633Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于博客">
<meta name="twitter:description" content="个人简介  &amp;emsp;&amp;emsp;大学生一枚，专业软件工程，对于热衷学习计算机知识，渴望能接触一流的软件开发流程和一线的技术。    联系方式 QQ: 1060172264 e-mail: DAmarkday@163.com  致谢&amp;emsp;&amp;emsp;非常感谢 叶落阁 大佬的主题和说明，让我能很大程序理解博客的构造和搭建。">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1"></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1.0.1"></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="true">
  <input class="theme_blog_path" value>
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>DAmarkday</span>
</div>

<div class="icon">
    
        
        <a title="rss" href="/atom.xml" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-rss"></use>
                </svg>
            
        </a>
        
    
        
        <a title="github" href="https://github.com/DAmarkday" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a title="csdn" href="https://blog.csdn.net/DAmarkday" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-csdn"></use>
                </svg>
            
        </a>
        
    
        
        <a title="oschina" href="https://my.oschina.net/yelog" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-oschina"></use>
                </svg>
            
        </a>
        
    
        
    
        
        <a title="email" href="mailto:DAmarkday@163.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=1060172264&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
        
        <a title="kugou" href="https://www.kugou.com/" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-kugou"></use>
                </svg>
            
        </a>
        
    
        
        <a title="neteasemusic" href="https://music.163.com/" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-neteasemusic"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(8)</small></div></li>
    
        
            
            <li><div data-rel="网络原理"><i class="fold iconfont icon-right"></i>网络原理<small>(3)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="抓包">抓包<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="kali">kali<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="通信协议">通信协议<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="安全漏洞">安全漏洞<small>(1)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="编程平台"><i class="fold iconfont icon-right"></i>编程平台<small>(2)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="微信小程序">微信小程序<small>(2)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="导论">导论<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="其他">其他<small>(1)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a style="border-right: 1px solid #fff; width: 49%"  class="about site_url"  href="/about">关于</a><a style="width: 50%"  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="8">
<input type="hidden" id="yelog_site_word_count" value="12.2k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://github.com/DAmarkday">DAmarkday</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="以 in: 开头进行全文搜索" autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">抓包</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">fiddler</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">网络原理</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">简易爬虫</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">漏洞</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">网络编程</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">kali</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">linux</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">微信小程序</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">javascript</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">导论</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">vscode</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">markdown</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">人脸识别</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">http</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        <a  class="网络原理 抓包 "
           href="/2019/08/06/get-talk/"
           data-tag="抓包,fiddler,网络原理"
           data-author="" >
            <span class="post-title" title="一个简单的监听设备上网教程(fiddler抓包)">一个简单的监听设备上网教程(fiddler抓包)</span>
            <span class="post-date" title="2019-08-06 22:19:27">2019/08/06</span>
        </a>
        
        <a  class="安全漏洞 "
           href="/2019/08/05/find-leak/"
           data-tag="简易爬虫,漏洞"
           data-author="" >
            <span class="post-title" title="学校教务网的一个安全漏洞">学校教务网的一个安全漏洞</span>
            <span class="post-date" title="2019-08-05 10:42:33">2019/08/05</span>
        </a>
        
        <a  class="网络原理 kali "
           href="/2019/08/29/kalilinux/"
           data-tag="网络编程,kali,linux"
           data-author="" >
            <span class="post-title" title="关于kali linux的安装教程踩坑建议">关于kali linux的安装教程踩坑建议</span>
            <span class="post-date" title="2019-08-29 16:16:35">2019/08/29</span>
        </a>
        
        <a  class="编程平台 微信小程序 "
           href="/2019/08/13/Mini-Program/"
           data-tag="微信小程序,javascript"
           data-author="" >
            <span class="post-title" title="微信小程序循环同步请求踩坑指南">微信小程序循环同步请求踩坑指南</span>
            <span class="post-date" title="2019-08-13 15:12:29">2019/08/13</span>
        </a>
        
        <a  class="导论 "
           href="/2019/07/30/导论/"
           data-tag="导论"
           data-author="" >
            <span class="post-title" title="导论">导论</span>
            <span class="post-date" title="2019-07-30 20:44:01">2019/07/30</span>
        </a>
        
        <a  class="其他 "
           href="/2019/07/30/vscode文档/"
           data-tag="vscode,markdown"
           data-author="" >
            <span class="post-title" title="vscode的markdown操作">vscode的markdown操作</span>
            <span class="post-date" title="2019-07-30 13:29:05">2019/07/30</span>
        </a>
        
        <a  class="编程平台 微信小程序 "
           href="/2019/08/23/BaiDuface/"
           data-tag="微信小程序,javascript,人脸识别"
           data-author="" >
            <span class="post-title" title="小程序人脸动态识别摇头点头采坑建议">小程序人脸动态识别摇头点头采坑建议</span>
            <span class="post-date" title="2019-08-23 07:55:08">2019/08/23</span>
        </a>
        
        <a  class="网络原理 通信协议 "
           href="/2019/09/01/http/"
           data-tag="网络原理,http"
           data-author="" >
            <span class="post-title" title="http协议的相关知识点">http协议的相关知识点</span>
            <span class="post-date" title="2019-09-01 21:01:03">2019/09/01</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-BaiDuface" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">小程序人脸动态识别摇头点头采坑建议</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
                <a href="javascript:" data-rel="编程平台">编程平台</a>/
            
                <a href="javascript:" data-rel="微信小程序">微信小程序</a>
            
        </span>
        
        
        <span class="tag">
            
            <a href="javascript:" class="color1">微信小程序</a>
            
            <a href="javascript:" class="color1">javascript</a>
            
            <a href="javascript:" class="color5">人脸识别</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2019-08-23 11:47:34'>2019-08-23 07:55</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:2k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#说明"><span class="toc-text">说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#探究"><span class="toc-text">探究</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#实现思路"><span class="toc-text">实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#定时器"><span class="toc-text">定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setTimeout和setInterval区别及选择"><span class="toc-text">setTimeout和setInterval区别及选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定时器代码"><span class="toc-text">定时器代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现功能过程"><span class="toc-text">实现功能过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#获取accessToken"><span class="toc-text">获取accessToken</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#云函数代码"><span class="toc-text">云函数代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小程序端代码"><span class="toc-text">小程序端代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始定时循环拍摄"><span class="toc-text">开始定时循环拍摄</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#循环拍照"><span class="toc-text">循环拍照</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发送请求"><span class="toc-text">发送请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#摇头点头顺序设置"><span class="toc-text">摇头点头顺序设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解析返回json文件"><span class="toc-text">解析返回json文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#人脸对比"><span class="toc-text">人脸对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#最后"><span class="toc-text">最后</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>&emsp;&emsp;应需求,在小程序内部弄一个人脸动态活体扫描,检测一下摇摇头,点点头之类的。但是在网上的相关信息却没有,偶尔有几个思路,所以就在这里记录下自己的探究历程</p>
</blockquote>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>&emsp;&emsp;首先说明的是这篇文章采用的是百度云的人脸识别,与腾讯的人脸识别不同的是,百度人脸识别的api还提供三维旋转的角度检测,这样对于实现检测人脸识别摇头和点头是非常简单的。</p>

<p><img src="/2019/08/23/BaiDuface/first.png" alt="百度云人脸识别接口说明"></p>
<h1 id="探究"><a href="#探究" class="headerlink" title="探究"></a>探究</h1><h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><p>&emsp;&emsp;创造一个定时器,在定时器里面使用拍照之后使用人脸识别接口,这样就变成动态检测了。</p>

<h3 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h3><h4 id="setTimeout和setInterval区别及选择"><a href="#setTimeout和setInterval区别及选择" class="headerlink" title="setTimeout和setInterval区别及选择"></a>setTimeout和setInterval区别及选择</h4>  <p>&emsp;&emsp;setTimeout和setInterval都可以用作定时器,但是我们得先大致区分一下两者的部分区别:</p>

<blockquote>
<p>&emsp;&emsp;setTimeout会保证在指定好的延时时间后执行,但是setInterval则不会这样。 如果function中的代码有耗时载操作,那么使用setTimeout方法递归,则可能会增加总递归的时间。 <br><br>&emsp;&emsp;而使用setInterval方法,如果程序中耗时比延时间隔长,则会立刻回调函数。( 更多关于setInterval计时不准确可以点击<a href="https://www.zhihu.com/question/20479535" target="_blank" rel="noopener">这里</a>了解。)</p>
</blockquote>
<p>&emsp;&emsp;因为setInterval计时并不准确,同时我们定时器同时存在耗时操作(调用百度云接口),所以我们这里就采用setTimeout +递归方式来实现定时。</p>
<h4 id="定时器代码"><a href="#定时器代码" class="headerlink" title="定时器代码"></a>定时器代码</h4><pre><code>every_camera_upload: function(acstoken) { //定时拍摄照片
let that = this;
timer = setTimeout(function() {//设置定时器,并赋给全局变量timer


 //that.camera().then(resx =&gt; {//循环拍照  
   // that.uploadBaiDuPicture(acstoken).then(rx =&gt;{//上传百度云接口
     // that.judge_face(rx);//获取返回的json数据并分析

   // });

    that.every_camera_upload(that.data.getAccessToken); //方法中调用定时器实现循环
//  });
}, 1500);

}
//clearTimeout(timer); //此方法不能放在定时器方法内部,
//用于清除新一轮循环中函数还未运行时清除定时器,
//也不能放在every_camera_upload()方法内部,应为要重复调用,应放于其他方法内部。</code></pre><p>&emsp;&emsp;解释一下代码,在方法内部,设置一个setTimeout赋给全局变量,在定时器内部调用camer方法,之后则重复调用every_camera_upload()方法实现递归。clearTimeout()的作用用于清除循环,必须在其他方法中使用。</p>

<h2 id="实现功能过程"><a href="#实现功能过程" class="headerlink" title="实现功能过程"></a>实现功能过程</h2><h3 id="获取accessToken"><a href="#获取accessToken" class="headerlink" title="获取accessToken"></a>获取accessToken</h3><p>&emsp;&emsp;阅读百度云人脸识别接口得知,先获取access_token进行身份验证,但我们不能将密钥密匙放在客户端上防止别人抓包逆工程获取到,此时可以将其放在服务器或者使用云开发的云函数上(博主使用的云函数)</p>

<h4 id="云函数代码"><a href="#云函数代码" class="headerlink" title="云函数代码"></a>云函数代码</h4><pre><code>// 云函数入口文件
 const cloud = require(&apos;wx-server-sdk&apos;);
 cloud.init();

// 云函数入口函数
var getAccessToken = function () { //人脸识别API
var https = require(&apos;https&apos;);
var qs = require(&apos;querystring&apos;);

const param = qs.stringify({
&apos;grant_type&apos;: &apos;client_credentials&apos;,
&apos;client_id&apos;: &apos;你的 Api Key&apos;,
&apos;client_secret&apos;: &apos;你的 Secret Key&apos;
});
var access_token;
return new Promise((resolve,reject) =&gt; {
 let body =[];
https.get(
{
  hostname: &apos;aip.baidubce.com&apos;,
  path: &apos;/oauth/2.0/token?&apos; + param,
  agent: false
},
function (res) {
  res.on(&apos;data&apos;,(chunk) =&gt; {
    body.push(chunk);


  }); 
  res.on(&apos;end&apos;, () =&gt;{
    let data = Buffer.concat(body).toString();
    let getData = JSON.parse(data);
     access_token = getData.access_token;
    console.log(access_token);
    resolve(access_token);
  }); 

    }
 );
}).then(res =&gt;{
return access_token;

});


}


exports.main = (event, context) =&gt; {
 let datas = getAccessToken(); 
 return datas;

}</code></pre><h4 id="小程序端代码"><a href="#小程序端代码" class="headerlink" title="小程序端代码"></a>小程序端代码</h4><pre><code>getAccessToken: function() { //获取accesstoken
 var x = new Promise((resolve, reject) =&gt; {
  wx.cloud.callFunction({
    name: &apos;getBaiDuAccessToken&apos;,
    data: {},
    success: resy =&gt; {
      console.log(resy);
      console.log(resy.result);
      resolve(resy.result);
    },
    fail: resy =&gt; {
      wx.showToast({
        title: &apos;accesstoken报错&apos;,
        icon: &apos;none&apos;,
        duration: 2000
      });
    }
  });
});
return x;
 }</code></pre><h3 id="开始定时循环拍摄"><a href="#开始定时循环拍摄" class="headerlink" title="开始定时循环拍摄"></a>开始定时循环拍摄</h3><p>&emsp;&emsp;获取到access_token后,就可以在小程序循环拍摄上传了,但注意的是access_token最好放在服务器上让小程序将照片发送到后端让后端发送请求接口,但考虑到诸多性能问题,博主就将其放在小程序端上。</p>

<h4 id="循环拍照"><a href="#循环拍照" class="headerlink" title="循环拍照"></a>循环拍照</h4><pre><code>every_camera_upload: function(acstoken) { //定时拍摄照片
  let that = this;
 timer = setTimeout(function() {
  that.camera().then(resx =&gt; {
    that.uploadBaiDuPicture(acstoken).then(rx =&gt;{
      that.judge_face(rx);
    });
    that.every_camera_upload(that.data.getAccessToken); //方法中调用定时器实现循环
  });
}, 1500);</code></pre><h3 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h3><p>&emsp;&emsp;发送请求最好由服务器来做,服务器解析之后返回给小程序端,博主将其放在小程序端。</p>

<pre><code>uploadBaiDuPicture: function(restoken) { //上传百度云照片并解析
  var base64 = wx.getFileSystemManager().readFileSync(this.data.tempImagePath, &apos;base64&apos;);
  let data = [{ //百度云的锅,在json格式外需要外加一个[]
    image: base64,
    image_type: &apos;BASE64&apos;
 }];
return new Promise((resolve, reject) =&gt; {
  wx.request({
    url: &apos;https://aip.baidubce.com/rest/2.0/face/v3/faceverify?access_token=&apos; + restoken,
    data: data,
    // dataType: &quot;json&quot;,
    method: &apos;POST&apos;,
    header: {
      &apos;Content-Type&apos;: &apos;application/json&apos;
    },
    success(res) {
      resolve(res);
    }
  })
});
}</code></pre> <p>&emsp;&emsp;由于拍摄的照片是在本地上,发送请求就必须将本地照片进行base64编码后放入data请求参数中,特别重要的一点,如果你碰上这种错误返回:</p>   

<p> <img src="/2019/08/23/BaiDuface/second.png" alt="接口返回错误222200"></p>
 <p>&emsp;&emsp;那八成是由于请求参数外没有加 [ ],如上代码显示,json请求格式外要 [] ,这个错误网上信息很少,解释为百度人脸识别v3版本的api表单是个list,接口开发文档也没有相关注明,所以请注意这个坑,引用:<a href="https://ai.baidu.com/forum/topic/show/870349" target="_blank" rel="noopener">活体检测error_code&quot;:222200&quot;</a></p>

<h3 id="摇头点头顺序设置"><a href="#摇头点头顺序设置" class="headerlink" title="摇头点头顺序设置"></a>摇头点头顺序设置</h3><pre><code>judge_face: function(res) { //判断用户点头摇头动作
    let that = this;
if (res.data.error_code == 0) {
  if (this.data.prove_face_front == false){
    that.judge_prove_face_front(res);
  }else if (that.data.judge_left_change_right_head_count &lt; 2) {
    that.judge_left_change_right_head(res); //判断用户摇头
  } else if(that.data.judge_down_to_up_head_count &lt; 2){
    that.judge_down_to_up_head(res); //判断用户点头
  }else {

    wx.showLoading({
      title: &apos;上传中&apos;,
    });
    innerAudioConext.src = &quot;/music/upload.mp3&quot;
    innerAudioConext.play();
    this.uploadUserPictureProve();
    clearTimeout(timer);

  }
} else if (res.data.error_code == 222202) {
  wx.showToast({
    title: &apos;未识别到脸部&apos;,
    icon: &apos;none&apos;,
    duration: 500
  });


} else {
  wx.showToast({
    title: &apos;未知错误&apos;,
    icon: &apos;none&apos;,
    duration: 500
  });
}</code></pre><p>  }</p>
<h3 id="解析返回json文件"><a href="#解析返回json文件" class="headerlink" title="解析返回json文件"></a>解析返回json文件</h3> <p>&emsp;&emsp;获取返回的json的参数pitch,yaw,为三维旋转角度,以此判断正脸</p>

<pre><code>judge_prove_face_front:function(res){
  let pitch = Math.abs(res.data.result.face_list[0].angle.pitch);
  let yaw = Math.abs(res.data.result.face_list[0].angle.yaw);
  if ((pitch &lt; 5 ) &amp;&amp; (yaw&lt;5)) {
  let font_face=this.data.tempImagePath
  this.setData({
    prove_face_front: true,
    save_font_face:font_face
  })
} else {
  wx.showToast({
    title: &apos;未检测到正脸&apos;,
    icon: &apos;none&apos;,
    duration: 1000
  });
}
}</code></pre> <p>&emsp;&emsp;播放语音,获取返回的json的参数yaw,用上一次获取的yaw减去这一次的yaw参数的绝对值判断是否摇头。</p>

<pre><code>judge_left_change_right_head: function(res) {
   if (this.data.music_count == 0) {
     innerAudioConext.src = &quot;/music/leftright.mp3&quot;
     innerAudioConext.play();
     this.data.music_count++;

}
let yaw = parseInt(res.data.result.face_list[0].angle.yaw);
if ((yaw &lt; 0 || yaw &gt; 0) &amp;&amp; (Math.abs(this.data.last_yaw - yaw)&gt;40)) {
  this.data.judge_left_change_right_head_count++;
  this.setData({
    last_yaw: yaw
  })
  console.log(&quot;摇头 &quot; + this.data.judge_left_change_right_head_count)
} else {
  console.log(&quot;yaoyaoyoa  &quot; + parseInt(this.data.last_yaw - yaw));
  console.log(&quot;yaoyaoyoa  &quot; + typeof (res.data.result.face_list[0].angle.yaw));
  wx.showToast({
    title: &apos;未检测到摇头&apos;,
    icon: &apos;none&apos;,
    duration: 1000
  });
}
}</code></pre> <p>&emsp;&emsp;播放语音,获取返回的json的参数pitch,用上一次获取的pitch减去这一次的pitch参数的绝对值判断是否点头。</p>



<pre><code>judge_down_to_up_head: function(res) {
if(this.data.music_count==1){
  innerAudioConext.src = &quot;/music/headupdown.mp3&quot;
  innerAudioConext.play();
  this.data.music_count++;

}
let pitch = res.data.result.face_list[0].angle.pitch;
if ((pitch &lt; 0 || pitch &gt; 0) &amp;&amp; (Math.abs(this.data.last_pitch - pitch) &gt; 5.5)) {
  this.data.judge_down_to_up_head_count++;
  this.setData({
    last_pitch: pitch
  })
  //console.log(&quot;点头 &quot; + this.data.judge_down_to_up_head_count)
} else {
 // console.log(&quot;点头 &quot; + this.data.judge_down_to_up_head_count)
 // console.log(&quot;点头ssssssssss &quot; + Math.abs(this.data.last_pitch - pitch))
  wx.showToast({
    title: &apos;未检测到点头&apos;,
    icon: &apos;none&apos;,
    duration: 1000
  });
}
}</code></pre><h3 id="人脸对比"><a href="#人脸对比" class="headerlink" title="人脸对比"></a>人脸对比</h3>   <p>&emsp;&emsp;所有验证成功后,就可以直接上传人脸对比了,关于人脸对比同样使用静默人脸对比,由于源码解释众多,本篇文章就不再重复讲解了。</p>


<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1>   <p>&emsp;&emsp;只看开发者文档注定会踩许多坑,希望能将有坑的地方记录下来,让更多人注意。感谢其他文章论坛提问的帮助,链接如下：<br>&emsp;&emsp;<a href>微信小程序—setTimeOut定时器的坑</a><br>&emsp;&emsp;<a href="https://ai.baidu.com/forum/topic/show/870349" target="_blank" rel="noopener">活体检测error_code&quot;:222200&quot;</a></p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 DAmarkday@163.com </span>
    </div>
</article>


<p>
    <a href="javascript:void(0)" class="dashang" onclick="dashangToggle()">赏</a>
</p>


<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>小程序人脸动态识别摇头点头采坑建议</p>
    <p><span class="copy-title">文章字数:</span><span class="post-count">2k</span></p>
    <p><span class="copy-title">本文作者:</span><a href="javascript:void(0)" title="DAmarkday">DAmarkday</a></p>
    <p><span class="copy-title">发布时间:</span>2019-08-23, 07:55:08</p>
    <p><span class="copy-title">最后更新:</span>2019-08-23, 11:47:34</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2019/08/23/BaiDuface/" title="小程序人脸动态识别摇头点头采坑建议">http://DAmarkday.com/2019/08/23/BaiDuface/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>



    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: '70eecd1fcd84551743c1',
            clientSecret: 'e40ff9f925396aab310a6ebc7bb48af399aec713',
            repo: 'DAmarkday.github.io',
            owner: 'DAmarkday',
            admin: ['DAmarkday'],
            id: location.pathname,
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2017-2021 DAmarkday</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" href="javascript:void(0)"></a>
    </div>
</div>
<div class="acParent"></div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="//cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#抓包','#fiddler','#网络原理','#简易爬虫','#漏洞','#网络编程','#kali','#linux','#微信小程序','#javascript','#导论','#vscode','#markdown','#人脸识别','#http',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: #fafafa;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("http://pic.netbian.com/uploads/allimg/170817/004839-150290211965c8.jpg");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
